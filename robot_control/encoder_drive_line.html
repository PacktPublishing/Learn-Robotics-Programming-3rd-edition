<!DOCTYPE html>
<html>
    <head>
        <title>Robot control - Encoder drive line</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <h1>Robot control - Encoder drive line</h1>
        <a href="index.html">Back to menu</a><br>
        <button id="launch">Launch</button>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <script type="module">
            import { connect, publish_when_clicked } from './mqtt_client.js';

            let loaded_plot = false;
            const plot_element = document.getElementById("plot");

            function handle_message(topic, message) {
                console.log("Received message: " + message.toString());
                //https://stackoverflow.com/questions/6016120/relative-url-to-a-different-port-number-in-a-hyperlink
                //https://www.w3schools.com/tags/tag_iframe.asp
                // When we receive the encoder control message, load the plot
                if(topic == "sensors/encoders/control" && !loaded_plot) {
                    loaded_plot = true;
                    let url = "http://" + window.location.hostname + ":5002";
                    plot_element.innerHTML =
                        "<iframe src='" + url + "'></iframe>";
                }
            }

            let mqttClient = connect(
                () => {
                    console.log("Connected to MQTT broker");
                    mqttClient.subscribe("sensors/encoders/control");
                    mqttClient.on('message', handle_message);
                },
            );

            publish_when_clicked(mqttClient, "launch", "launcher/start", "encoder_drive_line.service");
            publish_when_clicked(mqttClient, "start", "drive/start", "encoder_drive_line.service");
            publish_when_clicked(mqttClient, "stop", "drive/stop", "encoder_drive_line.service");
        </script>

        <div id="plot"></div>
    </body>
</html>
