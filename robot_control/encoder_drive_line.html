<!DOCTYPE html>
<html>
    <head>
        <title>Robot control - Encoder drive line</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <h1>Robot control - Encoder drive line</h1>
        <a href="index.html">Back to menu</a><br>
        <button id="launch" disabled="true">Launch</button>
        <button id="start" disabled="true">Start</button>
        <button id="stop">Stop</button>
        <button id="stop_service">Stop service</button>
        <script type="module">
            import { connect, publish_when_clicked } from './mqtt_client.js';

            let loaded_plot = false;
            const plot_element = document.getElementById("plot");

            function handle_message(topic, message) {
                console.log("Received message: " + message.toString());
                //https://stackoverflow.com/questions/6016120/relative-url-to-a-different-port-number-in-a-hyperlink
                //https://www.w3schools.com/tags/tag_iframe.asp
                // When we receive a subscribed encoder message, load the plot
                if(!loaded_plot) {
                    loaded_plot = true;
                    let url = "http://" + window.location.hostname + ":5002";
                    plot_element.innerHTML =
                        "<iframe src='" + url + "'></iframe>";
                }
            }

            let mqttClient = connect(
                () => {
                    console.log("Connected to MQTT broker");
                    mqttClient.subscribe("sensors/encoders/#");
                    mqttClient.on('message', handle_message);
                    document.getElementById("launch").disabled = false;
                    document.getElementById("start").disabled = false;
                },                
            );

            document.getElementById("stop_service").onclick = function() {
                mqttClient.publish("launcher/stop", "encoder_drive_line.service");
            };

            publish_when_clicked(mqttClient, "launch", "launcher/start", "encoder_drive_line.service");
            publish_when_clicked(mqttClient, "start", "drive/start", "{}");
            publish_when_clicked(mqttClient, "stop", "drive/stop", "{}");
        </script>

        <div id="plot"></div>
    </body>
</html>
